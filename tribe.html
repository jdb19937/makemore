<html>
<head>
<title>makemore peaple / comms</title>

<script src="/crypto.js"></script>
<script src="/moretp.js"></script>

<script>
function httpget(url, cb) {
  var i = new XMLHttpRequest;
  i.open('GET', url);
  i.overrideMimeType("text/plain");
  i.onload = function(e) {
    if (!(this.readyState == 4 && this.status == 200)) {
      return;
    }
    cb(this.responseText);
  }
  i.send();
}

function randstr() {
  return "" + Math.floor(Math.random() * 1000000000);
}

function onload() {
}

var socket;

var inbuf = new Uint8Array(0);

function socketmsg(m) {
  var x = new Uint8Array(m.data);

  inbuf = concat(inbuf, x);

    while (1) {
      var ret = moretpdec(inbuf);
      if (!ret) {
        break;
      }

      var msg = ret[0];
      var off = ret[1];
      inbuf = inbuf.slice(off, inbuf.length)

      if (msg[0] != "from") {
        continue;
      }

      var fromnom0 = msg[1];
      var tonom0 = msg[2];

      if (tonom0 == window.master) {
        continue;
      }

      var ar = msg[3];
      for (var off = 0; off < ar.length; off += 1024) {
        var msg = ar.subarray(off, off + 1024);
        var fromnom = '';
        for (var i = 0; i < 31 && msg[i] > 0; ++i) {
          fromnom += String.fromCharCode(msg[i]);
        }
        var tonom = '';
        for (var i = 32; i < 63 && msg[i] > 0; ++i) {
          tonom += String.fromCharCode(msg[i]);
        }


        var c = ar.subarray(off + 64, off + 1024);

        var pubkey = localStorage.getItem(fromnom + ".pubkey");
        pubkey = BigInt("0x" + pubkey);

        var privkey = BigInt("0x" + sessionStorage.getItem("privkey"));
        var txt = mmdec(c, pubkey, privkey);

        gotmsg(fromnom, tonom, txt);
      }
    }
}



function gotmsg(fromnom, tonom, txt) {
  var f = new Function('from', 'to', 'master', 'txt', window.scrtxt.value);
  var rsp = f(fromnom, tonom, window.master, txt);
  if (rsp.constructor == Object) {
    for (var i in rsp) {
      sendmsg(tonom, i, rsp[i]);
    }
  } else {
    if (rsp.constructor == Array) {
      for (var i in rsp) {
        sendmsg(tonom, fromnom, rsp[i]);
      }
    } else {
      sendmsg(tonom, fromnom, rsp);
    }
  }
}


function sendmsg(fromnom, tonom, txt) {
  var fromprivkey = BigInt("0x" + sessionStorage.getItem("privkey"));
  var frompubkey = BigInt("0x" +  sessionStorage.getItem("pubkey"));

  var topubkey = localStorage.getItem(tonom + ".pubkey");
  if (!topubkey) {
    return 0;
  }
  topubkey = BigInt("0x" + topubkey);

  var etxt0 = mmenc(txt, fromprivkey, topubkey);
  if (etxt0.length != 960) {
    return 0;
  }
  var etxt1 = mmenc(txt, fromprivkey, frompubkey);
  if (etxt1.length != 960) {
    return 0;
  }

  var b0 = new Blob(["be " + fromnom + " " + window.session + " ; to " + tonom + " <960 <960 ; be " + window.master + " " + window.session + "\n"]);
  var b1 = new Blob([etxt0]);
  var b2 = new Blob([etxt1]);
  var bb = new Blob([b0, b1, b2]);

  socket.send(bb);
  return 1;
}

function opensock() {
  socket = new WebSocket('wss://peaple.io:3333/', ['binary']);
  window.loginsocket = socket;
  socket.binaryType = 'arraybuffer';
  socket.onopen = function() {
    socket.send("be " + window.master + " " + window.session + "\n");
  };

  socket.onmessage = function(buf) {
    var txt = arrayBufferToString(buf.data);
    if (txt.substr(0, 8) == "session ") {
      window.socketready = 1;
      socket.onmessage = socketmsg;
    } else {
      window.socketready = 0;
      socket.close();
    }
  };

  socket.onclose = function() {
    window.socketready = 0;
  }
}

function upfile() {
  var reader = new FileReader();
  reader.onload = function(f) {
    scrtxt.value = f.target.result
  }
  reader.readAsText(fileupload.files[0]);
}

</script>

</head>

<body text="#ffffff" bgcolor="#000000">

$HEADER

<script>
if (window.usernom == '' || window.master == '') {
  window.location = "/";
}
opensock();
</script>

<script>headtribe.style.outline = '3px solid #00ff00';</script>

<br/>


<table width=1280 cellpadding=4 cellspacing=4>

<tr><td align="center">
<label id=uplab for="fileupload" style="border: 3px solid blue; display: inline-block; cursor: pointer">
    <i></i> <img width=144 height=24 src="/images/upload.png"/>
</label>
<input id="fileupload" style="display: none" type="file" onChange="upfile()"/>
</td></tr>

<tr><td align="center">
<textarea autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" rows=16 id=scrtxt style="background-color: darkblue; color: white; font-size: xx-large; width: 100%; height: auto; overflow: hidden; padding: 2px; display: block; resize: none">
// function(from, to, master, txt) {
return 'hi ' + from;
// }
</textarea>
</td></tr>

<tr><td align="center">
</td></tr>
</table>

</body>
</html>
