

<table width=1280 cellpadding=0 cellspacing=0>
  <tr>
    <td width=512 style='font-size: 40px'>[
      <a href="/"><img style="outline: 3px solid blue" id=headrand width=96 height=24 src="/images/rand.png"></a>
      | <a href="/new"><img style="outline: 3px solid blue" id=headnew width=72 height=24 src="/images/new.png"></a>
<!--
  <a href="/new/male"><img style="outline: 3px solid blue" width=24 height=24 src="/male.png?dev=2"></a>
  <a href="/new/female"><img style="outline: 3px solid blue" width=24 height=24 src="/female.png?dev=2"></a>
  <a href="/new/cat"><img style="outline: 3px solid blue" width=24 height=24 src="/cat.png?dev=2"></a>
  <a href="/new/dog"><img style="outline: 3px solid blue" width=24 height=24 src="/dog.png?dev=2"></a>
-->
      | <a id="linktop" href="/top"><img style="outline: 3px solid blue" id=headtop width=72 height=24 src="/images/top.png"></a>
      | <a href="/sh"><img style="outline: 3px solid blue" id=headsh width=48 height=24 src="/images/sh.png"></a>


<!--
|
<div style="display: inline; width: 300px">
  <span id="fb-root"></span>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.async = true;
    js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>
  <style type="text/css">
    .fb-share-fix {
      top: 3px;
    }
  </style>
  <span class="fb-share-button fb-share-fix"
    data-href="$URL"
    data-size="large"
    data-layout="button_count">
  </span>
</div>
-->



    ]</td>







    <td align="right" height="70">
<div id="userbar" style="display: none">
      <table>
        <tr>
          <td style="font-size: 40px">
            [
<!--
<a href="/buy"><img width=72 height=24 style="outline: 3px solid blue" id=buybutton src="/images/buy.png"></a> |
-->

<!--
<img width=120 height=24 src="/images/score.png">
<span style="font-family: monospace; font-size: 32px; color: green">$SCORE</span>
|
-->

<a href="/comms"><img height=24 width=120 style="outline: 3px solid blue" id=headcomms src="/images/comms.png"></a> |
<a href="/script"><img height=24 width=144 style="outline: 3px solid blue" id=headscript src="/images/script.png"></a> |


            <img width=144 height=24 onClick="logout()" style="cursor: pointer; outline: 3px solid blue" id=logoutbutton src="/images/logout.png">
            ]

<a id="userlink"><img align="center" style="border: 3px solid blue" id="userimg" width=64 height=64></a>

</td>
        </tr>
      </table>
</div>
<div id="loginbar" style="display: none">
      <table>
        <tr>
          <td rowspan="2" valign="center" style="font-size: 40px">
            [
          </td>

          <td align="right"><img width=48 height=16 alt="nom" onClick="nomlogin.value=''; nomlogin.focus()" src="/images/small_nom.png"/></td>
          <td> <input id="nomlogin" type="text" style="font-family: monospace; font-size: medium" size=32 maxlength=32 onClick="this.value=''" value=""/></td>

<script>if ("$NOM" && "$NOM".substr(0, 1) != '$') { nomlogin.value = '$NOM'; }</script>


          <td rowspan="2" valign="center" style="font-size: 40px">
<script>
function arrayBufferToString(buffer){
    var arr = new Uint8Array(buffer);
    var str = String.fromCharCode.apply(String, arr);
    return str;
}

function badpass() {
  nompass.value = '';
  if (nomlogin.value == '') {
    nomlogin.focus();
  } else {
    nompass.focus();
  }

  loginbutton.style.outline = "3px solid red";
  window.loginsocket = null;

  window.setTimeout(function() {
    loginbutton.style.outline = "3px solid blue";
  }, 1000);
}

function logout() {
  sessionStorage.clear();
  location.reload();
  return;
}

//function delcookie(n) {
//  var cookie_date = new Date();
//  cookie_date.setTime(cookie_date.getTime() - 1);
//  document.cookie = n + "=; path=/; expires=" + cookie_date.toGMTString();
//}
//function setcookie(n, v) {
//  var cookie_date = new Date();
//  cookie_date.setTime(cookie_date.getTime() + 86400);
//  document.cookie = n + "=" + v + "; path=/; expires=" + cookie_date.toGMTString();
//}

function check_loginstate() {
  var nom = sessionStorage.getItem('nom');
  var session = sessionStorage.getItem('session');
  var master = sessionStorage.getItem('master');
  if (!nom || !session || !master) {
    window.master = '';
    window.usernom = '';
    window.session = '';
    sessionStorage.clear();

    var lbar = document.getElementById('loginbar');
    lbar.style.display = 'block';
    var ubar = document.getElementById('userbar');
    ubar.style.display = 'none';

    loginbutton.style.outline = "3px solid blue";

    // logout();
    return;
  }

  window.usernom = nom;
  window.master = master;
  window.session = session;

//  setcookie('usernom', window.usernom);
//  setcookie('session', window.session);

  var lbar = document.getElementById('loginbar');
  lbar.style.display = 'none';
  var ubar = document.getElementById('userbar');
  ubar.style.display = 'block';

  userimg.src = "/" + window.usernom + ".png?dim=64";
  userlink.href = "/" + window.usernom;

  //var z = window.onlogin;
  //if (z) { if (Array.isArray(z)) { for (var w in z) { (z[w])(); } } else { z(); } }


  if (window.location.pathname != '/comms') {
    var i = new XMLHttpRequest;
    i.open('GET', '/newcomms.txt?nom=' + window.usernom + '&session=' + session);
    i.overrideMimeType("text/plain");
    i.onload = function(e) {
      if (!(this.readyState == 4 && this.status == 200)) {
        return;
      }
      var txt = this.responseText;
      if (txt == "1") {
        headcomms.style.outline = '3px solid orange';
var i = 0;
var blinker = window.setInterval(function() {
  headcomms.style.outline = (i % 2) ? '3px solid orange' : '3px solid blue';
  ++i;
}, 500);
//        headcomms.addEventListener('mouseover', function() {
//          window.clearInterval(blinker);
//          headcomms.style.outline = '3px solid blue';
//        });
      }
    }
    i.send();
  }
}


function getsession(username, password, pubkey, hexprivkey) {
  var socket = new WebSocket('wss://peaple.io:3333/', ['binary']);
  window.loginsocket = socket;
  socket.binaryType = 'arraybuffer';
  socket.onmessage = function(buf) {
    var txt = arrayBufferToString(buf.data);
    if (txt.substr(0, 8) == "session ") {
      var ses = txt.substr(8);
      var z = ses.indexOf('\n');
      if (z > -1) { ses = ses.substr(0, z); }
      sessionStorage.setItem('nom', username);
      sessionStorage.setItem('session', ses);
      sessionStorage.setItem('master', username);
      sessionStorage.setItem("privkey", hexprivkey);
      sessionStorage.setItem("pubkey", bufToBn(pubkey).toString(16));
      window.location.reload();
      // window.loginsocket = null;
      // check_loginstate();
    } else {
      badpass();
    }
    socket.close();
  };

  socket.onclose = function() {
    // badpass();
  }

  socket.onopen = function() {
    var blob0 = new Blob([username], {type: 'text/plain'});
    var blob1 = new Blob([password], {type: 'text/plain'});
    var blob2 = new Blob([pubkey]);
    var hdr = "be " + "<" + blob0.size + " <" + blob1.size + " <" + blob2.size + "\n";
    var bhdr = new Blob([hdr], {type: 'text/plain'});
    var sblob = new Blob([bhdr, blob0, blob1, blob2]);
    socket.send(sblob);
  };
}

function loadScript(url, callback)
{
   var head = document.getElementsByTagName('head')[0];
   var script = document.createElement('script');
   script.type = 'text/javascript';
   script.src = url;
   script.onreadystatechange = callback;
   script.onload = callback;
   head.appendChild(script);
}


function clicklogin() {
  loginbutton.style.outline = "3px solid yellow";

loadScript('/crypto.js', function() {

var login = nomlogin.value;
var seedpass = nompass.value;
var password;
if (seedpass == '') {
  badpass();
  return;
} else {
  password = sha256(sha256(login + "/" + seedpass) + "/" + seedpass);
}


var hexprivkey = sha256(sha256(login + "@" + seedpass) + "@" + seedpass);
var privkey = BigInt("0x" + hexprivkey);
var pubkey = modpow(egg, privkey, egp);
var pubkeybuf = bnToBuf(pubkey, 128);

getsession(login, password, pubkeybuf, hexprivkey)
});

}
</script>
            &nbsp; <img alt="login" width=120 height=24 id="loginbutton" onClick="clicklogin()" src="/images/login.png"/ style="cursor: pointer; outline: 3px solid blue"> ]
          </td>
        </tr>
        <tr>
          <td align="right"><img width=64 height=16 alt="pass" onClick="nompass.value=''; nompass.focus()" src="/images/small_pass.png"/></td>
          <td><input id="nompass" onkeypress="if (event.which == 13) { clicklogin(); }" type="password" style="font-family: monospace; font-size: medium" size=32 maxlength=32 /></td>
        </tr>
      </table>
    </div>

<script>
check_loginstate();
</script>




    </td>
  </tr>




  <tr>
    <td colspan=2>
      <div style="width: 1280px; height: 4px; background-color: #444444"></div>
    </td>
  </tr>
  <tr>
  <td> <img style="image-rendering: pixelated" width=640 height=48 src="/images/makemore.png"> </td>
  <td valign="top" align="right">
    <img style="image-rendering: pixelated" width=368 height=24 src="/images/createdby.png"><br/>
    <a id=linkemail><img style="image-rendering: pixelated" width=304 height=24 src="/images/email.png"></a>

<script>
var z = 'mai';
z += 'lto:';
z += String.fromCharCode(0x6A);
z += 'db1729';
z += String.fromCharCode(z.charCodeAt(7) - 0x2A);
z += 'gma';
z += 'il.com';
linkemail.href = z;
</script>

  </td>
  </tr>

  <tr>
    <td colspan=2>
      <div style="width: 1280px; height: 4px; background-color: #444444"></div>
    </td>
  </tr>




<script>
</script>

</table>

