
<style type="text/css">
.button {
  outline: 3px solid blue;
  cursor: pointer
}
</style>

<script>
var qarr = window.location.search.substr(1).split('&').filter(function(x) {
  return x.substr(0, 6) == "theme=";
}).map(function(x) {
  return x.substr(6);
});
if (qarr.length > 0) {
  sessionStorage.setItem('theme', qarr[0]);
}

var theme = sessionStorage.getItem('theme') || 'mork';

function make_emlabel() {
  var etxt = escape('[email]');
  var dim = 8;

  var w = 2 * dim * 17;
  var h = 3 * dim * 1;

  var u = "/button.png?txt=" + etxt + "&theme=" + theme + "&dim=" + dim + "&chop=0";
  document.write(
    "<img src='" +  u + "' " +
    "width=" + w + " height=" + h +
    ">"
  );
}
function make_label(txt, dim, nochop) {
  var etxt = escape(txt);
  dim = dim || 12;
  nochop = nochop || 0;
  var chop = !nochop ? 1 : 0;

  var id = 'head' + txt;
  var w = 2 * dim * txt.length;
  var h = (chop ? 2 : 3) * dim * 1;

  var u = "/button.png?txt=" + etxt + "&theme=" + theme + "&dim=" + dim + "&chop=" + chop;
  document.write(
    "<img alt='" + txt + "' id='" + id + "' src='" +  u + "' " +
    "width=" + w + " height=" + h +
    ">"
  );
}
function make_button(txt, onc, id, align, thm) {
  var etxt = escape(txt);
  dim = 12;
  var chop = 1;

  if (!id)
    id = 'head' + txt;
  var w = 2 * dim * txt.length;
  var h = (chop ? 2 : 3) * dim * 1;

  onc = onc || '';
  if (onc) {
    onc = " onClick='" + onc + "'";
  }

  align = align || '';
  if (align) {
    align = " align='" + align + "'";
  }

  thm = thm || theme;
 

  var u = "/button.png?txt=" + etxt + "&theme=" + thm + "&dim=" + dim + "&chop=" + chop;
  document.write(
    "<img alt='" + txt + "' id='" + id + "' src='" +  u + "' class='button' " +
    "width=" + w + " height=" + h + onc + align +
    ">"
  );
}

function nth(thm) {
  if (thm == 'mork') { return 'alfa'; }
  if (thm == 'alfa') { return 'ahoy'; }
  if (thm == 'ahoy') { return 'they'; }
  if (thm == 'they') { return 'mork'; }

  return 'mork';
}

function switchtheme() {
  var ntheme = nth(theme);

  sessionStorage.setItem('theme', ntheme);
  window.location.reload();
}

function make_themeswitcher() {
  var ntheme = nth(theme);

  var txt = ntheme;
  var etxt = escape(txt);
  var dim = 12
  var chop = 1;

  var w = 2 * dim * txt.length;
  var h = (chop ? 2 : 3) * dim * 1;

  var u = "/button.png?txt=" + etxt + "&theme=" + ntheme + "&dim=" + dim + "&chop=" + chop;
  document.write(
    "<img alt='" + ntheme + "' class='button' src='" +  u + "' width=" + w + " height=" + h +
    " onClick='switchtheme()'>"
  );
}

function make_logo() {
  var txt = 'MakeMore Peaple v1.0';
  var etxt = escape(txt);
  var dim = 16
  var chop = 0;

  var w = 2 * dim * txt.length;
  var h = (chop ? 2 : 3) * dim * 1;

  var u = "/button.png?txt=" + etxt + "&theme=" + theme + "&dim=" + dim + "&chop=" + chop;
  document.write(
    "<img alt='" + txt + "' src='" +  u + "' width=" + w + " height=" + h +
    ">"
  );
}

</script>


<table width=1280 cellpadding=0 cellspacing=0>
  <tr>
    <td style='vertical-align: center; font-size: 40px'>[

      <a href="/"><script>make_button('rand')</script></a>
      | <a id="newlink"><script>
window.newtype = 'new';
if (0 && Math.random(1) < 0.05) {
  if (Math.random(1) < 0.5) {
    window.newtype = 'cat';
  } else {
    window.newtype = 'dog';
  } 
}
make_button(window.newtype);
if (window.newtype == 'new') {
  newlink.href = '/new';
} else {
  newlink.href = '/new/' + window.newtype;
}
</script></a>
      | <a id="linktop" href="/top"><script>make_button('top')</script></a>
      | <a href="/sh"><script>make_button('sh')</script></a>
      | <script>make_themeswitcher()</script></a>

<script>
if (0 && localStorage.length > 0 || window.location.pathname == '/keys') {
  document.write('| <a href="/keys">');
  make_button('keys');
  document.write('</a>');
}
</script>


<!--
|
<div style="display: inline; width: 300px">
  <span id="fb-root"></span>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.async = true;
    js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>
  <style type="text/css">
    .fb-share-fix {
      top: 3px;
    }
  </style>
  <span class="fb-share-button fb-share-fix"
    data-href="$URL"
    data-size="large"
    data-layout="button_count">
  </span>
</div>
-->



    ]</td>







    <td align="right" height="70">
<div id="userbar" style="display: none">
      <table>
        <tr>
          <td style="font-size: 40px">
            [

<a href="/comms"><script>make_button('comms')</script></a> |
<a href="/script"><script>make_button('script')</script></a> |

      <script>make_button('logout', 'logout()')</script>
            ]

<a id="userlink"><img align="center" style="border: 3px solid blue" id="userimg" width=64 height=64></a>

</td>
        </tr>
      </table>
</div>
<div id="loginbar" style="display: none">
      <table>
        <tr>
          <td rowspan="2" valign="center" style="font-size: 40px">
            [
          </td>

          <td align="right"><script>make_label('nom', 8)</script></td>
          <td> <input id="nomlogin" type="text" style="font-family: monospace; font-size: medium" size=32 maxlength=32 onClick="this.value=''" value=""/></td>

<script>if ("$NOM" && "$NOM".substr(0, 1) != '$') { nomlogin.value = '$NOM'; }</script>


          <td rowspan="2" valign="center" style="font-size: 40px">
<script>
function arrayBufferToString(buffer){
    var arr = new Uint8Array(buffer);
    var str = String.fromCharCode.apply(String, arr);
    return str;
}

function badpass() {
  nompass.value = '';
  if (nomlogin.value == '') {
    nomlogin.focus();
  } else {
    nompass.focus();
  }

  headlogin.style.outline = "3px solid red";
  window.loginsocket = null;

  window.setTimeout(function() {
    headlogin.style.outline = "3px solid blue";
  }, 1000);
}

function logout() {
  sessionStorage.removeItem('nom');
  sessionStorage.removeItem('session');
  sessionStorage.removeItem('master');
  location.reload();
  return;
}

//function delcookie(n) {
//  var cookie_date = new Date();
//  cookie_date.setTime(cookie_date.getTime() - 1);
//  document.cookie = n + "=; path=/; expires=" + cookie_date.toGMTString();
//}
//function setcookie(n, v) {
//  var cookie_date = new Date();
//  cookie_date.setTime(cookie_date.getTime() + 86400);
//  document.cookie = n + "=" + v + "; path=/; expires=" + cookie_date.toGMTString();
//}

function check_loginstate() {
  var nom = sessionStorage.getItem('nom');
  var session = sessionStorage.getItem('session');
  var master = sessionStorage.getItem('master');
  if (!nom || !session || !master) {
    window.master = '';
    window.usernom = '';
    window.session = '';
    sessionStorage.removeItem('nom');
    sessionStorage.removeItem('session');
    sessionStorage.removeItem('master');

    var lbar = document.getElementById('loginbar');
    lbar.style.display = 'block';
    var ubar = document.getElementById('userbar');
    ubar.style.display = 'none';

    headlogin.style.outline = "3px solid blue";

    // logout();
    return;
  }

  window.usernom = nom;
  window.master = master;
  window.session = session;

//  setcookie('usernom', window.usernom);
//  setcookie('session', window.session);

  var lbar = document.getElementById('loginbar');
  lbar.style.display = 'none';
  var ubar = document.getElementById('userbar');
  ubar.style.display = 'block';

  userimg.src = "/" + window.usernom + ".png?dim=64";
  userlink.href = "/" + window.usernom;

  //var z = window.onlogin;
  //if (z) { if (Array.isArray(z)) { for (var w in z) { (z[w])(); } } else { z(); } }


  if (window.location.pathname != '/comms') {
    var i = new XMLHttpRequest;
    i.open('GET', '/newcomms.txt?nom=' + window.usernom + '&session=' + session);
    i.overrideMimeType("text/plain");
    i.onload = function(e) {
      if (!(this.readyState == 4 && this.status == 200)) {
        return;
      }
      var txt = this.responseText;
      if (txt == "1") {
        headcomms.style.outline = '3px solid orange';
var i = 0;
var blinker = window.setInterval(function() {
  headcomms.style.outline = (i % 2) ? '3px solid orange' : '3px solid blue';
  ++i;
}, 500);
//        headcomms.addEventListener('mouseover', function() {
//          window.clearInterval(blinker);
//          headcomms.style.outline = '3px solid blue';
//        });
      }
    }
    i.send();
  }
}


function getsession(username, password, pubkey, hexprivkey) {
  var socket = new WebSocket('wss://peaple.io:3333/', ['binary']);
  window.loginsocket = socket;
  socket.binaryType = 'arraybuffer';
  socket.onmessage = function(buf) {
    var txt = arrayBufferToString(buf.data);
    if (txt.substr(0, 8) == "session ") {
      var ses = txt.substr(8);
      var z = ses.indexOf('\n');
      if (z > -1) { ses = ses.substr(0, z); }
      sessionStorage.setItem('nom', username);
      sessionStorage.setItem('session', ses);
      sessionStorage.setItem('master', username);
      sessionStorage.setItem("privkey", hexprivkey);
      sessionStorage.setItem("pubkey", bufToBn(pubkey).toString(16));
      window.location.reload();
      // window.loginsocket = null;
      // check_loginstate();
    } else {
      badpass();
    }
    socket.close();
  };

  socket.onclose = function() {
    // badpass();
  }

  socket.onopen = function() {
    var blob0 = new Blob([username], {type: 'text/plain'});
    var blob1 = new Blob([password], {type: 'text/plain'});
    var blob2 = new Blob([pubkey]);
    var hdr = "be " + "<" + blob0.size + " <" + blob1.size + " <" + blob2.size + "\n";
    var bhdr = new Blob([hdr], {type: 'text/plain'});
    var sblob = new Blob([bhdr, blob0, blob1, blob2]);
    socket.send(sblob);
  };
}

function loadScript(url, callback)
{
   var head = document.getElementsByTagName('head')[0];
   var script = document.createElement('script');
   script.type = 'text/javascript';
   script.src = url;
   script.onreadystatechange = callback;
   script.onload = callback;
   head.appendChild(script);
}


function clicklogin() {
  headlogin.style.outline = "3px solid yellow";

loadScript('/crypto.js', function() {

var login = nomlogin.value;
var seedpass = nompass.value;
var password;
if (seedpass == '') {
  badpass();
  return;
} else {
  password = sha256(sha256(login + "/" + seedpass) + "/" + seedpass);
}


var hexprivkey = sha256(sha256(login + "@" + seedpass) + "@" + seedpass);
var privkey = BigInt("0x" + hexprivkey);
var pubkey = modpow(egg, privkey, egp);
var pubkeybuf = bnToBuf(pubkey, 128);

getsession(login, password, pubkeybuf, hexprivkey)
});

}
</script>
            &nbsp;
            <script>make_button('login', 'clicklogin()');</script>
            ]
          </td>
        </tr>
        <tr>
          <td align="right">
<script>make_label('pass', 8);</script>
          <td><input id="nompass" onkeypress="if (event.which == 13) { clicklogin(); }" type="password" style="font-family: monospace; font-size: medium" size=32 maxlength=32 /></td>
        </tr>
      </table>
    </div>

<script>
check_loginstate();
</script>




    </td>
  </tr>




  <tr>
    <td colspan=2>
      <div style="width: 1280px; height: 4px; background-color: #444444"></div>
    </td>
  </tr>
  <tr>
  <td> 

<script>make_logo()</script>

</td>
  <td valign="top" align="right">
    <script>make_label('created by Dan Brumleve', 8, 1);</script><br/>
    <a id=linkemail><script>make_emlabel();</script></a>

<script>
var z = 'mai';
z += 'lto:';
z += String.fromCharCode(0x6A);
z += 'db1729';
z += String.fromCharCode(z.charCodeAt(7) - 0x2A);
z += 'gma';
z += 'il.com';
linkemail.href = z;
</script>

  </td>
  </tr>

  <tr>
    <td colspan=2>
      <div style="width: 1280px; height: 4px; background-color: #444444"></div>
    </td>
  </tr>




<script>
</script>

</table>

